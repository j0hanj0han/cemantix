name: Regenerate HTML from solution

on:
  push:
    paths:
      - 'docs/solution.json'   # déclenché quand le Mac pousse la solution
  workflow_dispatch:            # déclenchement manuel

permissions:
  contents: write

# Architecture :
# - Le solveur tourne en CRON LOCAL sur Mac (run_daily.sh) — IP résidentielle
# - Mac génère docs/ et pousse sur GitHub
# - Ce workflow se déclenche sur le push et régénère le HTML si besoin
# - Pas besoin du modèle .bin ici (solution déjà dans docs/solution.json)

jobs:
  regenerate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if solution.json is for today
        id: check
        run: |
          TODAY=$(date +'%Y-%m-%d')
          if [ -f docs/solution.json ]; then
            DOC_DATE=$(python3 -c "import json; d=json.load(open('docs/solution.json')); print(d.get('date',''))")
            echo "doc_date=$DOC_DATE" >> "$GITHUB_OUTPUT"
            if [ "$DOC_DATE" = "$TODAY" ]; then
              echo "up_to_date=true" >> "$GITHUB_OUTPUT"
              echo "✅ solution.json est à jour pour $TODAY"
            else
              echo "up_to_date=false" >> "$GITHUB_OUTPUT"
              echo "⚠ solution.json date=$DOC_DATE, aujourd'hui=$TODAY — pas encore mis à jour par le Mac"
            fi
          else
            echo "up_to_date=false" >> "$GITHUB_OUTPUT"
            echo "⚠ docs/solution.json introuvable"
          fi

      - name: Set up Python (only if solution is ready)
        if: steps.check.outputs.up_to_date == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies (only if solution is ready)
        if: steps.check.outputs.up_to_date == 'true'
        run: pip install requests cloudscraper beautifulsoup4

      - name: Regenerate HTML from existing solution.json
        if: steps.check.outputs.up_to_date == 'true'
        run: |
          python3 - <<'EOF'
          import json, sys
          from pathlib import Path
          from datetime import date

          # Import generate.py helpers sans lancer main()
          sys.path.insert(0, '.')
          import generate as g

          data = json.loads(Path('docs/solution.json').read_text(encoding='utf-8'))
          today = date.fromisoformat(data['date'])
          puzzle_num = data['puzzle_num']
          word = data['word']
          hints = data.get('hints', {'level1': [], 'level2': [], 'level3': []})

          print(f"Régénération HTML pour {g.date_fr(today)} #{puzzle_num} '{word}'")
          g.generate_index_html(today, puzzle_num, word, hints)

          archive_dates = g.collect_archive_dates()
          g.update_sitemap(today, archive_dates)
          print("✅ index.html + sitemap.xml régénérés")
          EOF

      - name: Commit and push if HTML changed
        if: steps.check.outputs.up_to_date == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/index.html docs/sitemap.xml
          git diff --staged --quiet || git commit -m "chore: HTML $(date +'%Y-%m-%d') [skip ci]"
          git push

      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.up_to_date }}" = "true" ]; then
            echo "### ✅ HTML régénéré pour ${{ steps.check.outputs.doc_date }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ Pas d'action — solution.json pas encore mis à jour par le cron local Mac" >> $GITHUB_STEP_SUMMARY
            echo "Le cron local tourne à 08h05 heure de Paris. Vérifier run_daily.log si problème." >> $GITHUB_STEP_SUMMARY
          fi
